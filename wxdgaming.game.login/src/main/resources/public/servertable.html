<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script charset="utf-8" type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script charset="utf-8" type="text/javascript" src="/js/com.wxd.js"></script>
    <script charset="utf-8" type="text/javascript" src="/js/pageview.js"></script>
    <title>b</title>
    <link rel="stylesheet" type="text/css" href="/style/com.wxd.css"/>
    <link rel="stylesheet" type="text/css" href="/style/table.css"/>
    <style>
        .box {display: flex;flex-direction: column;}

        .root_box_top {height: 120px;}

        .root_box_center {flex: 1;}

        .root_box_bottom {height: 38px;}

        .root_box_bottom label {padding-left: 5px;padding-right: 5px;}

        .alertBoxBg .alertBox li {height: 23px;line-height: 20px;}

        .alertBoxBg .alertBox label {padding-left: 5px;padding-right: 5px;text-align: right;width: 80px;display: inline-block;}

        .alertBoxBg .alertBox input {width: 180px;border: #8c8c8c 1px solid;}
    </style>
    <script>

        let pageView = null;

        function search() {
            wxd.loading();
            let urlQuery = new wxd.Map().loadSearch();
            urlQuery.put("minTime", $("#minTime").val());
            urlQuery.put("maxTime", $("#maxTime").val());
            urlQuery.put("where", $("#labWhere").text());
            urlQuery.put("order", $("#labOrderBy").text());
            pageView.remoteGetData(urlQuery);
        }

        // 用于显示的格式化版本
        function formatForDisplay(str) {
            if (typeof str === "string") {
                return str;
            }
            return JSON.stringify(str, null, 2); // 会保留换行和缩进
        }

        function formatJsonWithNewlines(obj) {
            if (typeof obj === 'string') {
                try {
                    obj = JSON.parse(obj);
                } catch (e) {
                    // 如果解析失败，直接格式化字符串
                    return obj;
                }
            }
            // 使用2个空格进行缩进，自动包含换行符
            return JSON.stringify(obj, null, 2);
        }

        function escapeJSString(str) {
            return formatForDisplay(str).replace(/\\/g, "\\\\")
                .replace(/'/g, "\\'")
                .replace(/"/g, "\\\"")
                .replace(/\n/g, "\\n")
                .replace(/\r/g, "\\r")
                .replace(/\t/g, "\\t");
        }

        function createRow(number, row, index) {
            // language=HTML
            let tr = `
                <tr>
                    <td>${number}</td>
                    <td style="width: 180px;">
                        <a href="#">删除</a>
                        <a href="#" onclick="kick(${row.serverId})">踢下线</a>
                        <a href="#" onclick="editServer(${row.serverId},'${row.name}','${row.openTime}','${row.maintenanceTime}','${row.showLevel}')">修改</a>
                        <a href="#" onclick="editShowName(${row.serverId},'${row.name}','${row.showName}','${row.showNameExpireTime}')">冠名</a>
                    </td>
                    <td>${row.serverId}</td>
                    <td>${row.mainId}</td>
                    <td>${row.name}</td>
                    <td>${row.showName}</td>
                    <td>${row.showNameExpireTime}</td>
                    <td>${row.openTime}</td>
                    <td>${row.maintenanceTime}</td>
                    <td>${row.host}</td>
                    <td>${row.port}</td>
                    <td>${row.httpPort}</td>
                    <td>${row.onlineSize}</td>
                    <td>${row.showLevel}</td>
                    <td>${row.lastSyncTime}</td>
                </tr>
            `;
            return tr;
        }

        function alertShow(self, title) {
            let content = $(self).text();
            content = formatJsonWithNewlines(content);
            console.log(typeof content, content);
            new wxd.message.Alert(`<pre>${content}</pre>`, title).show();
        }

        $(() => {
            wxd.loading();
            pageView = new PageView("/admin/gameserver/queryList", search, createRow);
            search();
        });

        let whereJsonArray = [];

        function addWhere() {
            let whereJson = {};
            whereJson["where"] = $("#where").val();
            whereJson["and"] = $("#and").val();
            whereJson["whereValue"] = $("#whereValue").val();
            whereJsonArray[whereJsonArray.length] = whereJson;
            $("#labWhere").text(JSON.stringify(whereJsonArray));
            $("#whereValue").val("")
            $("#and").val("=");
        }

        function clearWhere() {
            whereJsonArray = [];
            $("#labWhere").text("");
        }

        let orderByJsonArray = [];

        function addOrder() {
            let orderJson = {};
            orderJson["orderField"] = $("#orderField").val();
            orderJson["orderOption"] = $("#orderOption").val();
            orderByJsonArray[orderByJsonArray.length] = orderJson;
            $("#labOrderBy").text(JSON.stringify(orderByJsonArray));
        }

        function clearOrder() {
            orderByJsonArray = [];
            $("#labOrderBy").text("");
        }

        function editServer(serverId, serverName, openTime, maintenanceTime, showLevel) {
            // language=HTML
            let content = `
                <div>
                    <ul>
                        <li><label>服务ID:</label><span>${serverId}</span></li>
                        <li>
                            <label for="updateServerName">服务名字:</label><input id="updateServerName" type="text" value="${serverName}">
                        </li>
                        <li>
                            <label for="updateOpenTime">开服时间:</label><input id="updateOpenTime" type="datetime-local" value="${openTime}"/>
                        </li>
                        <li>
                            <label for="updateMaintenanceTime">维护时间:</label><input id="updateMaintenanceTime" type="datetime-local" value="${maintenanceTime}"/>
                        </li>
                        <li>
                            <label for="updateServerName">显示等级:</label><input id="updateShowLevel" type="text" value="${showLevel}">
                        </li>
                    </ul>
                </div>
            `;
            let alertBox = new wxd.message.Alert(content, "编辑区服");
            alertBox.okShow = "确认";
            alertBox.okCallback = () => {
                return new wxd.netty.PostRequest(
                    "/admin/gameserver/editServer",
                    {
                        serverId: serverId,
                        serverName: $("#updateServerName").val(),
                        openTime: $("#updateOpenTime").val(),
                        maintenanceTime: $("#updateMaintenanceTime").val(),
                        showLevel: $("#updateShowLevel").val()
                    },
                    (data) => {
                        wxd.message.notice(data.msg);
                        if (data.code === 1) {
                            search();
                            return true;
                        } else {
                            return false;
                        }
                    })
                    .async(false)
                    .send();
            };
            alertBox.show();
        }

        function kick(serverId) {
            let urlQuery = new wxd.Map().loadSearch();
            urlQuery.put("serverId", serverId);
            new wxd.netty.PostRequest("/admin/gameserver/kick", urlQuery.toString(), (data) => {
                wxd.message.notice(data.msg);
            }).send();
        }

        function editShowName(serverId, serverName, showName, showNameExpireTime) {
            // language=HTML
            let content = `
                <div>
                    <ul>
                        <li><label>服务ID:</label><span>${serverId}-${serverName}</span></li>
                        <li>
                            <label for="updateShowName">区服名字:</label><input id="updateShowName" type="text" value="${showName}">
                        </li>
                        <li>
                            <label for="updateShowNameExpireTime">过期时间:</label><input id="updateShowNameExpireTime" type="datetime-local" value="${showNameExpireTime}"/>
                        </li>
                    </ul>
                </div>
            `;

            let alertBox = new wxd.message.Alert(content, "区服冠名");
            alertBox.okShow = "提交";
            alertBox.okCallback = () => {
                return new wxd.netty.PostRequest(
                    "/admin/gameserver/editShowName",
                    {
                        serverId: serverId,
                        showName: $("#updateShowName").val(),
                        showNameExpireTime: $("#updateShowNameExpireTime").val()
                    },
                    (data) => {
                        wxd.message.notice(data.msg);
                        if (data.code === 1) {
                            search();
                            return true;
                        } else {
                            return false;
                        }
                    }
                ).async(false).send();
            };
            alertBox.show();
        }

        function addServer() {
            // language=HTML
            let content = `
                <div>
                    <ul>
                        <li><label for="addServerId">服务ID:</label><input id="addServerId" type="text"></li>
                        <li><label for="addServerName">服务名字:</label><input id="addServerName" type="text"></li>
                        <li><label for="addOpenTime">开服时间:</label><input id="addOpenTime" type="datetime-local"/>
                        </li>
                    </ul>
                </div>
            `;

            let alertBox = new wxd.message.Alert(content, "新增区服");
            alertBox.okShow = "新增";
            alertBox.okCallback = () => {
                console.log("addServer");
                return new wxd.netty.PostRequest(
                    "/admin/gameserver/addServer",
                    {
                        serverId: $("#addServerId").val(),
                        serverName: $("#addServerName").val(),
                        openTime: $("#addOpenTime").val()
                    },
                    (data) => {
                        wxd.message.notice(data.msg);
                        if (data.code === 1) {
                            search();
                            return true;
                        } else {
                            return false;
                        }
                    }).async(false).send();
            };
            alertBox.show();
        }

    </script>
</head>
<body>
<div class="root box">
    <div class="root_box_top btn_box" style="padding-left: 20px; padding-top: 8px; text-align: left;vertical-align: center;">
        <label for="minTime">开始日期: </label><input id="minTime" type="date"/>
        <label for="maxTime">结束日期: </label><input id="maxTime" type="date"/>
        <br>
        <label for="where">查询条件:</label>

        <select id="where">
            <option value="serverId">区分ID</option>
            <option value="mainId">主服ID</option>
            <option value="name">名称</option>
            <option value="host">IP</option>
            <option value="port">port</option>
            <option value="httpPort">webPort</option>
            <option value="onlineSize">在线人数</option>
        </select>

        <select id="and" style="width: 60px;">
            <option value="=">=</option>
            <option value="<="><=</option>
            <option value="<"><</option>
            <option value=">=">>=</option>
            <option value=">">></option>
        </select>

        <input id="whereValue" type="text"/>
        <input type="button" onclick="addWhere();" value="添加"/>
        <input type="button" onclick="clearWhere();" value="清理"/>
        <br>
        <label for="labWhere">查询条件:</label><label id="labWhere"></label>
        <br>
        <label for="orderField">排序条件:</label>

        <select id="orderField">
            <option value="serverId">区分ID</option>
            <option value="mainId">主服ID</option>
            <option value="name">名称</option>
            <option value="host">IP</option>
            <option value="port">port</option>
            <option value="httpPort">webPort</option>
            <option value="onlineSize">在线人数</option>
        </select>

        <select id="orderOption" style="width: 60px;">
            <option value="DESC">降序</option>
            <option value="ASC">升序</option>
        </select>

        <input type="button" onclick="addOrder();" value="添加"/>
        <input type="button" onclick="clearOrder();" value="清理"/>
        <br>
        <label for="labOrderBy">排序条件:</label><label id="labOrderBy"></label>
        <br>
        <br>
        <button onclick="search();">查询</button>
        <button onclick="addServer()">新增</button>
    </div>
    <div class="root_box_center tableDom" style="margin: 10px; padding-right: 10px;border-radius: 0; overflow-x: auto;">
        <table style="min-width: 1400px;">
            <thead>
            <tr>
                <th>编号</th>
                <th style="width: 180px;">操作</th>
                <th>区分ID</th>
                <th>主服ID</th>
                <th>名称</th>
                <th>冠名</th>
                <th>冠名到期时间</th>
                <th>开服时间</th>
                <th>维护时间</th>
                <th>IP</th>
                <th>port</th>
                <th>webPort</th>
                <th>在线</th>
                <th>显示等级</th>
                <th>更新时间</th>
            </tr>
            </thead>
            <tbody class="tbody">
            </tbody>
        </table>
    </div>
    <div class="root_box_bottom">

    </div>
</div>
</body>
</html>