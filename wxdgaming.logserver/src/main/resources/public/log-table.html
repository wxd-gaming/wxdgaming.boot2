<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script charset="utf-8" type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script charset="utf-8" type="text/javascript" src="/js/com.wxd.js"></script>
    <script charset="utf-8" type="text/javascript" src="/js/pageview.js"></script>
    <title>æ—¥å¿—æŸ¥è¯¢ç³»ç»Ÿ</title>
    <link rel="stylesheet" type="text/css" href="/style/com.wxd.css"/>
    <style>
        :root {
            --primary-color: #1890ff;
            --border-color: #d9d9d9;
            --hover-color: #f5f5f5;
            --success-color: #52c41a;
            --warning-color: #faad14;
        }
        
        .root.box {
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .root_box_top {
            background: #fafafa;
            border-bottom: 1px solid var(--border-color);
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .root_box_center {
            flex: 1;
            overflow: auto;
            background: white;
        }

        .root_box_bottom {
            height: auto; /* æ”¹ä¸ºè‡ªåŠ¨é«˜åº¦ä»¥é€‚åº”åˆ†é¡µç»„ä»¶ */
            min-height: 40px;
            background: #f0f2f5;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center; /* å±…ä¸­æ˜¾ç¤ºåˆ†é¡µç»„ä»¶ */
            padding: 8px 20px; /* å¢åŠ å†…è¾¹è· */
            flex-shrink: 0;
            position: relative; /* ä¸ºåˆ†é¡µç»„ä»¶å®šä½æä¾›ä¸Šä¸‹æ–‡ */
        }

        /* åˆ†é¡µç»„ä»¶æ ·å¼ä¼˜åŒ– */
        .root_box_bottom > div {
            width: 100%;
            text-align: center;
            padding: 4px 0;
        }

        .root_box_bottom label {
            margin: 0 4px;
            font-size: 14px;
            color: #333;
        }

        .root_box_bottom select {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            margin: 0 4px;
        }

        .root_box_bottom a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 8px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .root_box_bottom a:hover {
            background-color: var(--hover-color);
            text-decoration: underline;
        }

        .root_box_bottom #lab_row_count,
        .root_box_bottom #lab_page_index,
        .root_box_bottom #lab_page_max {
            display: inline-block;
            min-width: 40px;
            text-align: center;
            border: 1px solid #d9d9d9;
            background-color: white;
            padding: 2px 4px;
            border-radius: 2px;
            margin: 0 2px;
        }

        .form-group {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .form-group label {
            min-width: 80px;
            font-weight: 500;
            color: #333;
        }

        input[type="date"], input[type="text"], select {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="date"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .btn {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 8px;
        }

        .btn:hover {
            background: var(--hover-color);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn-success:hover {
            background: #73d13d;
        }

        .tableDom {
            margin: 0;
            border-radius: 0;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th {
            background: #fafafa;
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            word-wrap: break-word;
            max-width: 300px;
        }

        tr:hover td {
            background: var(--hover-color);
        }

        .condition-display {
            background: #f0f8ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 8px 0;
            font-size: 13px;
        }

        .condition-item {
            display: inline-block;
            background: #e6f7ff;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 8px;
            margin-bottom: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-group label {
                min-width: auto;
                margin-bottom: 4px;
            }
            
            .btn {
                margin-bottom: 8px;
            }

            /* ç§»åŠ¨ç«¯åˆ†é¡µæ ·å¼ä¼˜åŒ– */
            .root_box_bottom > div {
                font-size: 12px;
            }

            .root_box_bottom a {
                margin: 0 4px;
                padding: 2px 4px;
            }

            .root_box_bottom label {
                font-size: 12px;
                margin: 0 2px;
            }
        }
    </style>
    <script>
        let pageView = null;
        let whereJsonArray = [];
        let orderByJsonArray = [];

        function search() {
            wxd.loading();
            let urlQuery = new wxd.Map().loadSearch();
            urlQuery.put("minTime", $("#minTime").val());
            urlQuery.put("maxTime", $("#maxTime").val());
            urlQuery.put("where", $("#labWhere").text());
            urlQuery.put("order", $("#labOrderBy").text());
            pageView.remoteGetData(urlQuery);
        }

        function excel() {
            wxd.loading();
            let urlQuery = new wxd.Map().loadSearch();
            urlQuery.put("minTime", $("#minTime").val());
            urlQuery.put("maxTime", $("#maxTime").val());
            urlQuery.put("where", $("#labWhere").text());
            urlQuery.put("order", $("#labOrderBy").text());
            urlQuery.put("pageIndex", pageView.pageIndex());
            urlQuery.put("pageSize", pageView.pageSize());

            new wxd.netty.PostRequest("/admin/log/excel", urlQuery.toString(), (response) => {
                console.log(response)
                if (response.code === 1) {
                    wxd.netty.download(response.data);
                    wxd.loading_close();
                } else {
                    wxd.loading_close();
                }
            }).send();
        }

        // ä¼˜åŒ–æ ¼å¼åŒ–å‡½æ•°
        function formatForDisplay(str) {
            if (typeof str === "string") {
                return str;
            }
            return JSON.stringify(str, null, 2);
        }

        function formatJsonWithNewlines(obj) {
            if (typeof obj === 'string') {
                try {
                    obj = JSON.parse(obj);
                } catch (e) {
                    return obj;
                }
            }
            return JSON.stringify(obj, null, 2);
        }

        function escapeJSString(str) {
            return formatForDisplay(str).replace(/\\/g, "\\\\")
                .replace(/'/g, "\\'")
                .replace(/"/g, "\\\"")
                .replace(/\n/g, "\\n")
                .replace(/\r/g, "\\r")
                .replace(/\t/g, "\\t");
        }

        // ä¼˜åŒ–è¡Œåˆ›å»ºå‡½æ•°
        function createRow(number, row, index) {
            let tr = `<tr ondblclick="alertShow2(${index})" style="cursor: pointer;">`;
            for (const key in pageView.columns) {
                let column = pageView.columns[key];
                let columnName = column.name;
                let columnComment = column.comment;
                let columnStyle = column.style;
                let columntitle = column.title;
                let rowValue = row[columnName];
                
                if (rowValue === null || rowValue === undefined) {
                    rowValue = "";
                }
                
                // æ·»åŠ æ–‡æœ¬æˆªæ–­å¤„ç†
                if (typeof rowValue === 'string' && rowValue.length > 50) {
                    rowValue = `<span title="${rowValue}">${rowValue.substring(0, 50)}...</span>`;
                }
                
                tr += `<td style="${columnStyle}" title="${columntitle}">${rowValue}</td>`;
            }
            tr += `</tr>`;
            return tr;
        }

        function alertShow2(index) {
            let content = pageView.items[index];
            content = formatJsonWithNewlines(content);
            new wxd.message.Alert(`<pre style="max-height: 400px; overflow: auto;">${content}</pre>`, "è¯¦æƒ…").show();
        }

        // æ–°å¢åŠŸèƒ½ï¼šå¿«é€Ÿè®¾ç½®æ—¥æœŸèŒƒå›´
        function setDateRange(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - days);
            
            $("#minTime").val(start.toISOString().split('T')[0]);
            $("#maxTime").val(end.toISOString().split('T')[0]);
        }

        // æ–°å¢åŠŸèƒ½ï¼šæ¸…é™¤æ‰€æœ‰æ¡ä»¶
        function clearAll() {
            $("#minTime").val("");
            $("#maxTime").val("");
            clearWhere();
            clearOrder();
        }

        // ä¼˜åŒ–æ¡ä»¶æ˜¾ç¤º
        function updateConditionDisplay() {
            let whereHtml = "";
            whereJsonArray.forEach((item, index) => {
                whereHtml += `<span class="condition-item">${item.where} ${item.and} "${item.whereValue}"</span>`;
            });
            $("#whereDisplay").html(whereHtml || "æ— æŸ¥è¯¢æ¡ä»¶");
            
            let orderHtml = "";
            orderByJsonArray.forEach((item, index) => {
                orderHtml += `<span class="condition-item">${item.orderField} ${item.orderOption}</span>`;
            });
            $("#orderDisplay").html(orderHtml || "æ— æ’åºæ¡ä»¶");
        }

        function addWhere() {
            let whereJson = {};
            whereJson["where"] = $("#where").val();
            whereJson["and"] = $("#and").val();
            whereJson["whereValue"] = $("#whereValue").val();
            
            if (!whereJson.whereValue) {
                alert("è¯·è¾“å…¥æŸ¥è¯¢å€¼");
                return;
            }
            
            whereJsonArray.push(whereJson);
            $("#labWhere").text(JSON.stringify(whereJsonArray));
            $("#whereValue").val("");
            updateConditionDisplay();
        }

        function clearWhere() {
            whereJsonArray = [];
            $("#labWhere").text("");
            updateConditionDisplay();
        }

        function addOrder() {
            let orderJson = {};
            orderJson["orderField"] = $("#orderField").val();
            orderJson["orderOption"] = $("#orderOption").val();
            orderByJsonArray.push(orderJson);
            $("#labOrderBy").text(JSON.stringify(orderByJsonArray));
            updateConditionDisplay();
        }

        function clearOrder() {
            orderByJsonArray = [];
            $("#labOrderBy").text("");
            updateConditionDisplay();
        }

        $(() => {
            wxd.loading();
            let urlQuery = new wxd.Map().loadSearch();
            pageView = new PageView("/admin/log/page", search, createRow);
            pageView.gameId = urlQuery.get("gameId");

            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæœ€è¿‘7å¤©
            setDateRange(7);

            let url = "/admin/log/title";
            let map = new wxd.Map();
            map.loadSearch();
            new wxd.netty.PostRequest(url, map.toString(), (response) => {
                if (response.code === 1) {
                    document.title = response.comment;
                    $(".tableDom").attr("style", $(".tableDom").attr("style") + "" + response.style);
                    let data = response.data;
                    for (let i = 0; i < data.length; i++) {
                        let item = data[i];
                        pageView.columns[item.name] = item;
                        $("#where").append(`<option value="${item.name}">${item.comment}</option>`);
                        $("#orderField").append(`<option value="${item.name}">${item.comment}</option>`);
                        let l = `<th class="${item.name}" style="${item.style}" title="${item.title}">${item.comment}</th>`;
                        $(".table_head").append(l);
                    }
                    search();
                }
            }).send();

        });
    </script>
</head>
<body>
<div class="root box">
    <div class="root_box_top">
        <div class="form-group">
            <label for="minTime">å¼€å§‹æ—¥æœŸ:</label>
            <input id="minTime" type="date"/>
            <label for="maxTime">ç»“æŸæ—¥æœŸ:</label>
            <input id="maxTime" type="date"/>
            <button class="btn" onclick="setDateRange(1)">ä»Šå¤©</button>
            <button class="btn" onclick="setDateRange(7)">è¿‘7å¤©</button>
            <button class="btn" onclick="setDateRange(30)">è¿‘30å¤©</button>
        </div>

        <div class="form-group">
            <label>æŸ¥è¯¢æ¡ä»¶:</label>
            <select id="where"></select>
            <select id="and" style="width: 80px;">
                <option value="=">=</option>
                <option value="<="><=</option>
                <option value="<"><</option>
                <option value=">=">>=</option>
                <option value=">">></option>
                <option value="ilike">åŒ…å«</option>
                <option value="notilike">ä¸åŒ…å«</option>
            </select>
            <input id="whereValue" type="text" placeholder="è¾“å…¥æŸ¥è¯¢å€¼"/>
            <button class="btn" onclick="addWhere()">æ·»åŠ æ¡ä»¶</button>
            <button class="btn" onclick="clearWhere()">æ¸…é™¤æ¡ä»¶</button>
        </div>

        <div class="condition-display">
            <strong>å½“å‰æŸ¥è¯¢æ¡ä»¶:</strong> <span id="whereDisplay">æ— æŸ¥è¯¢æ¡ä»¶</span>
        </div>

        <div class="form-group">
            <label>æ’åºæ¡ä»¶:</label>
            <select id="orderField"></select>
            <select id="orderOption" style="width: 80px;">
                <option value="DESC">é™åº</option>
                <option value="ASC">å‡åº</option>
            </select>
            <button class="btn" onclick="addOrder()">æ·»åŠ æ’åº</button>
            <button class="btn" onclick="clearOrder()">æ¸…é™¤æ’åº</button>
        </div>

        <div class="condition-display">
            <strong>å½“å‰æ’åºæ¡ä»¶:</strong> <span id="orderDisplay">æ— æ’åºæ¡ä»¶</span>
        </div>

        <div class="form-group">
            <button class="btn btn-primary" onclick="search()">ğŸ” æŸ¥è¯¢</button>
            <button class="btn btn-success" onclick="excel()">ğŸ“Š å¯¼å‡ºExcel</button>
            <button class="btn" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
        </div>
    </div>
    
    <div class="root_box_center tableDom">
        <table>
            <thead>
            <tr class="table_head"></tr>
            </thead>
            <tbody class="tbody">
            </tbody>
        </table>
    </div>
    
    <!-- åˆ†é¡µç»„ä»¶å°†ç”± pageview.js è‡ªåŠ¨æ’å…¥åˆ°è¿™é‡Œ -->
    <div class="root_box_bottom"></div>
</div>
</body>
</html>